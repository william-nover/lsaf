<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');class Team extends CI_Controller {	public $arrMenu = array();	public $data;	public $privilege = array();	public $section = 11; //get module group id from database	public $module_id = 46; //get module id from database	public $module = "Team";		public function __construct()	{		parent::__construct();                              if( ! $_SESSION)                {                    session_start();                }		if(empty($_SESSION['admin_data'])){			session_destroy();			redirect(BASE_URL_BACKEND."/signin");			exit();		}				$this->load->model(array('backend/Model_team','backend/Model_menu_frontend','backend/model_alias', 'backend/model_language','backend/model_logcms'));		$this->load->helper(array('funcglobal','menu','accessprivilege','alias'));				//get menu from helper menu		$this->arrMenu = menu();		$this->data = array();                $this->data['ListMenu'] = $this->arrMenu;                $this->data['CountMenu'] = count($this->arrMenu);		                		//check privilege module		$this->privilege = accessprivilegeuserlevel($_SESSION['admin_data']['user_level_id'], $this->module_id);	}		public function index()	{            		$this->view();	}		function view(){		$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;				@$searchkey = "";		@$searchby = "";		$where = "";		$orderBy = "";		@$perpage = "";				if(isset($_POST["tbSearch"])){			$this->session->unset_userdata(array("searchkey" => '', "searchby" => '', "perpage" => ''));						@$searchkey = $this->security->xss_clean(secure_input($_POST['searchkey']));			@$searchby = $this->security->xss_clean(secure_input($_POST['searchby']));			@$perpage = $this->security->xss_clean(secure_input($_POST['perpage']));						$pesan = array();			if (@$searchkey=="") {				$pesan[] = 'Keyword search is empty';			} else if (@$searchby=="") {				$pesan[] = 'Search by has not been choose';			}						if (! count($pesan)==0 ) {				foreach ($pesan as $indeks=>$pesan_tampil) {					//$this->data['error'] = $pesan_tampil;					$this->session->unset_userdata(array("searchkey" => '', "searchby" => '', "perpage" => ''));				}			} else {				$this->session->set_userdata(array("searchkey" => @$searchkey, "searchby" => @$searchby, "perpage" => @$perpage));				if(isset($_POST['searchkey'])){					@$searchkey = $_SESSION['searchkey'];				}				if(isset($_POST['searchby'])){					@$searchby = $_SESSION['searchby'];				}								if(@$searchkey != "" && @$searchby != ""){					$where   =   " WHERE  ".@$searchby." LIKE '%". @$searchkey ."%' ";				}			}			} else {			@$searchkey = $_SESSION['searchkey'];			@$searchby = $_SESSION['searchby'];						if(@$searchkey != "" && @$searchby != ""){				$where   =   " WHERE ".@$searchby." LIKE '%". @$searchkey ."%' ";			} else {				$where   .=   " ";			}						if(isset($_POST['perpage'])){				@$perpage = $this->security->xss_clean(secure_input($_POST['perpage'])); 				$this->session->set_userdata(array("perpage" => @$perpage));			} else {				@$perpage = $_SESSION['perpage'];;								if(@$perpage == ""){					@$perpage = PER_PAGE;				}			}		}				$orderBy = "ORDER BY team_order ASC";				$cond 			= $where." ".$orderBy;		$rsTeam		= $this->Model_team->getListTeam($cond);		$base_url		= BASE_URL_BACKEND."/team/view/";		$total_rows		= count($rsTeam);		$per_page		= @$perpage;				$this->data['paging']		= pagging($base_url , $total_rows, $per_page);		$page = ($this->uri->segment(4)) ? $this->uri->segment(4) : 1;		$start = $per_page*$page - $per_page;		if ($start<0) $start = 0;		$cond .= " LIMIT ".$start.",".$per_page;		$ListTeam = $this->Model_team->getListTeam($cond);		$this->data["ListTeam"] = $ListTeam;				//extract privilege		$this->data["list"] = $this->privilege[0];		$this->data["view"] = $this->privilege[1];		$this->data["add"] = $this->privilege[2];		$this->data["edit"] = $this->privilege[3];		$this->data["publish"] = $this->privilege[4];		$this->data["approve"] = $this->privilege[5];		$this->data["delete"] = $this->privilege[6];		$this->data["order"] = $this->privilege[7];				$this->data['searchkey'] = @$searchkey;		$this->data['searchby'] = @$searchby;		$this->data['perpage'] = @$perpage;				$this->data['total'] = $total_rows;				$this->load->view('backend/header',$this->data);		$this->load->view('backend/team/list');	}		public function add(){		//extract privilege		$this->data["approve"] = $this->privilege[2];		//echo $this->data["approve"].'approve';				if($this->data["approve"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}				$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;				$this->load->view('backend/header',$this->data);		$this->load->view('backend/team/add',$this->data);	}		public function doAdd(){		//extract privilege		$this->data["approve"] = $this->privilege[2];				if($this->data["approve"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}				$tb = $_POST['tbSave'];		if (!$tb) {			redirect(BASE_URL_BACKEND."/pages");			exit();		}				$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;						$teamtitle = $this->security->xss_clean(secure_input($_POST['teamtitle']));		$teamshortdesc = secure_input_editor($_POST['teamshortdesc']);		$teamdesc = secure_input_editor($_POST['teamdesc']);		$teamimageurl = $this->security->xss_clean(secure_input($_POST['teamimageurl']));				$pesan = array();		// Validasi data		if ($teamtitle=="") {			$pesan[] = 'Team Title is empty';		} else if ($teamshortdesc=="") {			$pesan[] = 'Team Short Description is empty';		} else if ($teamdesc=="") {			$pesan[] = 'Team Description is empty';		} 						if (! count($pesan)==0 ) {			foreach ($pesan as $indeks=>$pesan_tampil) {				$this->data['error'] = $pesan_tampil;								$this->data['teamtitle']=$teamtitle;				$this->data['teamshortdesc']=$teamshortdesc;				$this->data['teamdesc']=$teamdesc;				$this->data['teamimageurl']=$teamimageurl;								$this->load->view('backend/header',$this->data);				$this->load->view('backend/team/add',$this->data);			}		} else {			$cekTeam = $this->Model_team->checkTeam($teamtitle);			$countTeam = count($cekTeam);						if ($countTeam > 0 ) {				$this->data['error']='Team Title '.$teamtitle.' already exist';								$this->data['teamtitle']=$teamtitle;				$this->data['teamshortdesc']=$teamshortdesc;				$this->data['teamdesc']=$teamdesc;				$this->data['teamimageurl']=$teamimageurl;								$this->load->view('backend/header',$this->data);				$this->load->view('backend/team/add',$this->data);			} else {				$teamimageurl = str_replace(BASE_URL,"",$teamimageurl);					$teamid = $this->Model_team->insertTeam($teamtitle,$teamshortdesc,$teamdesc,$teamimageurl);								redirect(BASE_URL_BACKEND."/team/");			}			}		}		function active($id){		if (empty($id)) {			redirect(BASE_URL_BACKEND."/team");			exit();		}				//extract privilege		$this->data["approve"] = $this->privilege[5];				if($this->data["approve"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}				$active = $this->Model_team->activeTeam($id);				//Cache JSON Team		$ListTeam = $this->generateTeam();		createCache($ListTeam,"team");		//End Cache JSON Team		redirect(BASE_URL_BACKEND."/team");			}		function delete($id){		if (empty($id)) {			redirect(BASE_URL_BACKEND."/team");			exit();		}				//extract privilege		$this->data["delete"] = $this->privilege[6];				if($this->data["delete"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}				$delete = $this->Model_team->deleteTeam($id);				//Cache JSON Team		$ListTeam = $this->generateTeam();		createCache($ListTeam,"team");		//End Cache JSON Team				redirect(BASE_URL_BACKEND."/team");	}		public function edit($id){		if (empty($id)) {			redirect(BASE_URL_BACKEND."/team");			exit();		}		//extract privilege		$this->data["approve"] = $this->privilege[3];				if($this->data["approve"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}				$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;				$rsTeam = $this->Model_team->getTeam($id);  // mengambil database dari model untuk dikirim ke view		$countTeam = count($rsTeam);				$this->data['rsTeam'] = $rsTeam;		$this->data['countTeam'] = $countTeam;				$this->load->view('backend/header',$this->data);		$this->load->view('backend/team/edit',$this->data);	}		public function doEdit($id){		$tb = $_POST['tbEdit'];		if (!$tb OR $id == '') {			redirect(BASE_URL_BACKEND."/team");			exit();		}				//extract privilege		$this->data["approve"] = $this->privilege[3];				if($this->data["approve"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}				$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;				$rsTeam = $this->Model_team->getTeam($id);  // mengambil database dari model untuk dikirim ke view		$countTeam = count($rsTeam);				$this->data['rsTeam'] = $rsTeam;		$this->data['countTeam'] = $countTeam;				$teamtype = 3;		$teamtitle = $this->security->xss_clean(secure_input($_POST['teamtitle']));		$teamtitleOld = $this->security->xss_clean(secure_input($_POST['teamtitleOld']));		$teamshortdesc = secure_input_editor($_POST['teamshortdesc']);		$teamdesc = secure_input_editor($_POST['teamdesc']);		$teamimageurl = $this->security->xss_clean(secure_input($_POST['teamimageurl']));				$pesan = array();		// Validasi data		if ($teamtitle=="") {			$pesan[] = 'Team Title is empty';		} else if ($teamshortdesc=="") {			$pesan[] = 'Team Short Description is empty';		} else if ($teamdesc=="") {			$pesan[] = 'Team Description is empty';		} 				if (! count($pesan)==0 ) {			foreach ($pesan as $indeks=>$pesan_tampil) {				$this->data['error'] = $pesan_tampil;								$this->load->view('backend/header',$this->data);				$this->load->view('backend/team/edit',$this->data);			}		} else {			$cekTeam = $this->Model_team->checkTeam($teamtype,$teamtitle);			$countTeam = count($cekTeam);						if($teamtitle == $teamtitleOld){				$countTeam = 0;			}						if ($countTeam > 0 ) {				$this->data['error']='Team Title '.$teamtitle.' already exist';								$this->load->view('backend/header',$this->data);				$this->load->view('backend/team/edit',$this->data);			} else {				$teamimageurl = str_replace(BASE_URL,"",$teamimageurl);								$update = $this->Model_team->updateTeam($id,$teamtitle,$teamshortdesc,$teamdesc,$teamimageurl);								//Cache JSON Team				$ListTeam = $this->generateTeam();				createCache($ListTeam,"team");				//End Cache JSON Team								redirect(BASE_URL_BACKEND."/team/");			}			}			}		public function doOrder(){				$order = $this->security->xss_clean($_POST['order']);				if($order == ""){			redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);			exit();		} 				foreach($order as $id => $ordervalue){			$this->Model_team->updateOrder($id,$ordervalue);                        echo $ordervalue;		}		 //Cache JSON Team				$ListTeam = $this->generateTeam();				createCache($ListTeam,"team");				//End Cache JSON Team		redirect(BASE_URL_BACKEND.'/Team');	}	function generateTeam(){		$rsTeam			= $this->Model_team->getListTeam(" WHERE team_active_status = 1 ORDER BY team_order ASC ");			return $rsTeam;	}	}